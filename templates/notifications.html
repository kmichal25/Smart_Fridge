<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Powiadomienia - Twoja lodówka</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    .notification-item {
      background-color: #dcdcdc;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .notification-item p {
      margin: 0 0 12px 0;
      font-weight: 500;
    }

    .notification-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .notification-buttons button {
      flex: 1 1 auto;
      min-width: 140px;
    }
  </style>
</head>
<body>
  <header class="top-bar">
    <img src="{{ url_for('static', filename='img/SmartFridgelogo.jpg') }}" alt="Logo" class="logo-img" />
    <nav class="nav-links" id="navLinks">
      <a href="{{ url_for('dashboard.dashboard') }}"><button class="nav-btn">Twoja lodówka</button></a>
      <a href="{{ url_for('dashboard.add_product') }}"><button class="nav-btn">Dodaj produkt</button></a>
      <a href="{{ url_for('dashboard.recipes') }}"><button class="nav-btn">Dostępne przepisy</button></a>
      <a href="{{ url_for('dashboard.notifications') }}"><button class="nav-btn">Powiadomienia</button></a>
      <a href="{{ url_for('auth.logout') }}"><button class="nav-btn logout">Wyloguj się</button></a>
    </nav>
  </header>

  <main class="container">
    <h2 class="section-title">Powiadomienia o produktach</h2>
    <div id="notificationsList"></div>
  </main>

  <script>
    async function fetchNotifications() {
      try {
        const res = await fetch('/products', { credentials: 'include' });
        const products = await res.json();
        const today = new Date();

        const notificationsContainer = document.getElementById('notificationsList');
        notificationsContainer.innerHTML = '';

        products.forEach(p => {
          const expiry = new Date(p.expiryDate);
          const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
          if (diffDays <= 3) {
            const notif = document.createElement('div');
            notif.className = 'notification-item';

            if (diffDays <= 1) {
              notif.innerHTML = `
                <p><strong>${p.name}</strong> jest <span style="color:red;">przeterminowany</span>!</p>
                <div class="notification-buttons">
                  <button class="btn-primary" onclick="deleteProduct('${p.name}')">Usuń produkt</button>
                  <button class="btn-secondary" onclick="ignoreNotification('${p.name}', this)">Ignoruj</button>
                </div>
              `;
            } else {
              notif.innerHTML = `
                <p><strong>${p.name}</strong> wkrótce się zepsuje (za ${diffDays} dni).</p>
                <div class="notification-buttons">
                  <button class="btn-primary" onclick="window.location.href='{{ url_for('dashboard.recipes') }}'">Zobacz dostępne przepisy</button>
                  <button class="btn-secondary" onclick="ignoreNotification('${p.name}', this)">Ignoruj</button>
                </div>
              `;
            }

            notificationsContainer.appendChild(notif);
          }
        });

        if (!notificationsContainer.hasChildNodes()) {
          notificationsContainer.innerHTML = '<p>Brak nowych powiadomień.</p>';
        }
      } catch (err) {
        console.error('Błąd ładowania powiadomień:', err);
      }
    }

    function deleteProduct(name) {
      fetch(`/products/${encodeURIComponent(name)}`, {
        method: 'DELETE',
        credentials: 'include'
      })
      .then(res => {
        if (res.ok) {
          fetchNotifications(); // Odśwież listę bez alertu
        } else {
          console.error('Błąd podczas usuwania produktu.');
        }
      });
    }

    function ignoreNotification(name, button) {
      const notifElement = button.closest('.notification-item');
      if (notifElement) {
        notifElement.remove();
      }

      const notificationsContainer = document.getElementById('notificationsList');
      if (!notificationsContainer.hasChildNodes()) {
        notificationsContainer.innerHTML = '<p>Brak nowych powiadomień.</p>';
      }
    }

    window.addEventListener('DOMContentLoaded', fetchNotifications);
  </script>
</body>
</html>
