<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Powiadomienia - Twoja lodówka</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

</head>
<body>
  <header class="top-bar">
    <img src="{{ url_for('static', filename='img/SmartFridgelogo.jpg') }}" alt="Logo" class="logo-img" />
    <nav class="nav-links" id="navLinks">
      <a href="{{ url_for('dashboard.dashboard') }}"><button class="nav-btn">Twoja lodówka</button></a>
      <a href="{{ url_for('dashboard.add_product') }}"><button class="nav-btn">Dodaj produkt</button></a>
      <a href="{{ url_for('dashboard.recipes') }}"><button class="nav-btn">Dostępne przepisy</button></a>
      <a href="{{ url_for('dashboard.notifications') }}"><button class="nav-btn">Powiadomienia</button></a>
      <a href="{{ url_for('auth.logout') }}"><button class="nav-btn logout">Wyloguj się</button></a>
    </nav>
  </header>

  <main class="container">
    <h2 class="section-title">Powiadomienia o produktach</h2>
    <div id="notificationsList"></div>
  </main>

  <!-- Modal komunikatu -->
  <div id="modalOverlay"></div>
  <div id="modalMessage"></div>

  <script>
    async function fetchNotifications() {
      try {
        const res = await fetch('/products', { credentials: 'include' });
        const products = await res.json();
        const today = new Date();

        const notificationsContainer = document.getElementById('notificationsList');
        notificationsContainer.innerHTML = '';

        products.forEach(p => {
          const expiry = new Date(p.expiryDate);
          const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
          if (diffDays <= 3) {
            const notif = document.createElement('div');
            notif.className = 'notification-item';

            if (diffDays <= 1) {
              notif.innerHTML = `
                <p><strong>${p.name}</strong> jest <span style="color:red;">przeterminowany</span>!</p>
                <div class="notification-buttons">
                  <button class="btn-primary" onclick="deleteProduct('${p.name}')">Usuń produkt</button>
                  <button class="btn-secondary" onclick="ignoreNotification('${p.name}', this)">Ignoruj</button>
                </div>
              `;
            } else {
              notif.innerHTML = `
                <p><strong>${p.name}</strong> wkrótce się zepsuje (za ${diffDays} dni).</p>
                <div class="notification-buttons">
                  <button class="btn-primary" onclick="window.location.href='{{ url_for('dashboard.recipes') }}'">Zobacz dostępne przepisy</button>
                  <button class="btn-secondary" onclick="ignoreNotification('${p.name}', this)">Ignoruj</button>
                </div>
              `;
            }

            notificationsContainer.appendChild(notif);
          }
        });

        if (notificationsContainer.children.length === 0) {
          notificationsContainer.innerHTML = '<p>Brak nowych powiadomień.</p>';
        }
      } catch (err) {
        console.error('Błąd ładowania powiadomień:', err);
      }
    }

    function showMessage(message) {
      const modalMessage = document.getElementById('modalMessage');
      const modalOverlay = document.getElementById('modalOverlay');

      modalMessage.textContent = message;
      modalMessage.style.display = 'block';
      modalOverlay.style.display = 'block';

      setTimeout(() => {
        modalMessage.style.display = 'none';
        modalOverlay.style.display = 'none';
      }, 2000);
    }

    function deleteProduct(name) {
      fetch(`/products/${encodeURIComponent(name)}`, {
        method: 'DELETE',
        credentials: 'include'
      })
      .then(res => {
        if (res.ok) {
          showMessage('Produkt został usunięty.');
          fetchNotifications();
        } else {
          showMessage('Błąd podczas usuwania produktu.');
          console.error('Błąd podczas usuwania produktu.');
        }
      })
      .catch(() => {
        showMessage('Błąd połączenia z serwerem.');
      });
    }

    function ignoreNotification(name, button) {
      const notifElement = button.closest('.notification-item');
      if (notifElement) {
        notifElement.remove();
      }

      const notificationsContainer = document.getElementById('notificationsList');
      if (notificationsContainer.children.length === 0) {
        notificationsContainer.innerHTML = '<p>Brak nowych powiadomień.</p>';
      }
    }

    document.getElementById('modalOverlay').addEventListener('click', () => {
      document.getElementById('modalMessage').style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
    });

    window.addEventListener('DOMContentLoaded', fetchNotifications);
  </script>
</body>
</html>
